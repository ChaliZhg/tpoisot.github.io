---
layout: post
title: Python wrapper for mangal
author: Tim
type: note
tags:
- mangal
- python
---

I use `python` more than I use `R` for my own job. `R` is good to share
things with people, but it's a little bit slower, and orders of magnitude
quirkier, than `python`. So I decided to write a `python` wrapper for the
`mangal` API, which you can [find on *GitHub*][pymangal]. It works with
`python` 2.6 and 2.7 (at least the test suite passes on these two versions).

The goal is *not* to release something as full-featured as the `rmangal`
package (though the core abilities will be here). Rather, I wanted a tool that
is "pythonic", easy to use, and programmed extremely defensively so that it
can be used for automated analyses. There is a minimal [documentation][rtfd]
online, which will hopefully get better over time as I understand the
`sphinx` markup.

The syntax is relatively similar to that of the `rmangal` package. Everything starts by the instansiation of a `mangal()` class.

~~~python
>>> import pymangal as pm
>>> api = pm.mangal(url='http://localhost:8000')
>>> api.resources
[u'interaction', u'network', u'reference', u'taxa', u'trait', u'dataset', u'environment', u'item', u'user', u'population']
~~~

The methods implemented by the `mangal` class are `List`, `Get`, and `Post`
(`Patch` is coming soon, and `Post` support is sketchy at best). They work
almost in the same way as their `R` counterparts. For example, getting a
list of all networks can be done with:

~~~python
>>> all_net = api.List('network')
>>> len(all_net)
17
~~~

The only significant difference is that, by default, the `python` version will only return the first 20 results. If you want more than 20  results, you need to use `autopage=True`:

~~~python
>>> twenty_taxa = api.List('taxa')
>>> len(twenty_taxa)
20
>>> all_taxa = api.List('taxa', autopage=True)
>>> len(all_taxa)
38
~~~

The *big* advantage of the `python` version is that, when uploading data, there
is a validation of the way they are formatted. Internally, there is a function
taking care of reading the API scheme, and returning it as a `json` schema,
against which data are checked. It's probably simpler with a demonstration...

~~~python
>>> print json.dumps(api.schemes['trait'], indent=2)
## I have cut some of the elements for the sake of brevity
{
   "$schema": "http://json-schema.org/draft-04/schema#", 
   "required": [
      "value", 
      "owner", 
      "name"
   ], 
   "type": "object", 
   "properties": {
      "name": {
         "type": "string", 
         "description": "The name of the measured trait"
      }, 
      "value": {
         "type": "string", 
         "description": "The value of the trait"
      }, 
      "units": {
         "type": "string", 
         "description": "Units in which the trait was measured"
      }
   }, 
   "title": "Autogenerated JSON schema"
}
~~~

The data are validated *automatically*, so you don't have to bother about checking them yourself. For example, let's try with a badly formatted, and with a correctly formatted, taxa [^1]:

~~~python
>>> bad_taxa = {'name': 'Vulpes lagopus', 'vernacular': 'arctic fox', 'eol': 1053894, 'status': 'valid'}
# "valid" is not an acceptable value for "status" ("confirmed" is)
>>> ok_taxa = {'name': 'Vulpes lagopus', 'vernacular': 'arctic fox', 'eol': 1053894, 'status': 'confirmed'}

>>> arctic_fox = 
>>> arctic_fox = api.Post('taxa', bad_taxa)
# Skipping some lines...
jsonschema.exceptions.ValidationError: 'valid' is not one of [u'confirmed', u'trophic species', u'morphospecies', u'nomen dubium', u'nomen oblitum', u'nomen nudum', u'nomen novum', u'nomen conservandum', u'species inquirenda']

Failed validating 'enum' in schema['properties'][u'status']:
{'description': u'The taxonomic status of the taxa.',
   'enum': [u'confirmed',
   u'trophic species',
   u'morphospecies',
   u'nomen dubium',
   u'nomen oblitum',
   u'nomen nudum',
   u'nomen novum',
   u'nomen conservandum',
   u'species inquirenda'],
'type': u'string'}

On instance[u'status']:
'valid'

>>> arctic_fox = api.Post('taxa', ok_taxa)
>>> arctic_fox['id']
103
~~~

Note that the `validate` function of the `jsonschema` will tell you what is
wrong with the data, and show you the relevant excerpt from the schema. This
really helps finding out what it wrong with the data you try to upload.

---

As a final note: I am using *[Coveralls.io][coveralls]* for the first time,
and I am extremely impressed. In short, *coveralls* will read the results
of the `coverage` command, and tell you the proportion of your code with
corresponding test cases. *Coveralls* is integrated with *TravisCI*, a
continuous integration engine runnign the test suite each time I commit
changes to the *GitHub* repository (so I have confirmation that the new
versions pass  the tests). And finally, the documentation is auto-generated
using *Read The Docs*, which extracts the informations directly from the
code. These are really impressive tools to work with, and they kind of force
good practices upon you -- which is a good thing.

[^1]: As usual, posting and patching requires that you have a username and password. There will be a way to register through the `python` package in the future.

[pymangal]: https://github.com/mangal-wg/pymangal
[coveralls]: https://coveralls.io/r/mangal-wg/pymangal
[rtfd]: http://pymangal.readthedocs.org/en/latest/
