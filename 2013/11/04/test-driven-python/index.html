<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
extensions: ["tex2jax.js"],
jax: ["input/TeX", "output/HTML-CSS"],
tex2jax: {
inlineMath: [ ['$','$'], ["\\(","\\)"] ],
displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
processEscapes: true
},
"HTML-CSS": { availableFonts: ["TeX"] }
});
</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<link href="/lib/fontawesome/css/font-awesome.min.css" rel="stylesheet">

<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-11830706-1', 'timotheepoisot.fr');
ga('send', 'pageview');
</script>

<link rel="stylesheet" href="/lib/skeleton/css/normalize.css">
<link rel="stylesheet" href="/lib/skeleton/css/skeleton.css">

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript" src="/lib/site.js" charset="utf-8"></script>

<link rel="stylesheet/less" type="text/css" href="/lib/style.less" />
<script type="text/javascript" src="/lib/less.min.js" charset="utf-8"></script>

<title>Timothée Poisot | Notes on test-driven development (in Python)</title>

  </head>
  <body><a id="pagetop"></a>

    <!-- .container is main centered wrapper -->
    <div class="container">

      <div class="head">
        <h1>Timothée Poisot</h1>
        <h2>Computational Ecologist</h2>
      </div>

      <nav class="navbar">
  <div class="container">
   <ul class="nav-list">
     <li><a href="/">Home</a></li>
     <li><a href="/software/">Software</a></li>
     <li><a href="/research/">Research</a></li>
     <li><a href="/blog/" class="active">Blog</a></li>
     <li><a href="/papers/">Papers</a></li>
     <li><a href="/colophon/">Colophon</a></li>
     <!-- <li><a href="#pagetop" class="gototop">Top</a></li> -->
   </ul>
 </div>
</nav>


      <!-- columns should be the immediate child of a .row -->
      <div class="row">
        <div class="twelve column content">
          <div class="entry">
<div class='post-title'>2013/11/04<a class="readmore" href="/2013/11/04/test-driven-python/">Notes on test-driven development (in Python)</a></div>
<div class='post-meta'>Written by Tim</div>
<p>I&#39;m looking into the methodology of <em>test-driven development</em>, that is when
you write your tests <em>before</em> writing your code. The advertised benefit is
that you know in advance the behavior of your code, and it will make it easier
to implement and debug. This <a href="http://www.onlamp.com/pub/a/python/2004/12/02/tdd_pyunit.html">paper at O&#39;Reilly</a> is a good introduction
(although the exact functions of <code>unittest</code> it uses are now deprecated). To
get started, I&#39;ll work on a simple script that takes a series of numerical
values, and divide them by their max, to get the equivalent series of values
but in [0;1]. Let&#39;s start with the basics:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">unittest</span>     <span class="c"># for testing</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>  <span class="c"># for other things</span>
</code></pre></div>
<p>The first function I&#39;d like to write will be called <code>scale</code>, and it will take a
(<code>numpy</code>) array of numerical values, and return the same array divided by its
maximal value. So my first <em>unit test</em> will test that the function performs
as needed:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">scaleTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TextCase</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">testOnKnownResult</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">KnownInput</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
      <span class="n">Scaled</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">KnownInput</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">Scaled</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Scaled</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.5</span><span class="p">))</span>
</code></pre></div>
<p>There are a number of stupid-proofing steps required. First, the function
cannot work when all values in the array are 0, or if there are negative
values, so I&#39;ll write a test for that. I want the function <code>scale</code> to raise a
<code>ValueError</code>.</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">testNegative</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
   <span class="n">WithNeg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
   <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">WithNeg</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">testNull</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
   <span class="n">OnlyNull</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
   <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">OnlyNull</span><span class="p">)</span>
</code></pre></div>
<p>Now I have one test to check that the expected behavior is indeed obtained,
and two tests to check that the input values are correct. Things are starting
to look good! The one final thing that I want to enforce is the type of
inputs. Specifically, I want <code>numpy</code> arrays of numeric types. If this is
not the case, the <code>scale</code> function will raise a <code>TypeError</code>.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">testType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
   <span class="n">WithChar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="s">'0.0'</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
   <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="nb">TypeError</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">WithCar</span><span class="p">)</span></code></pre></div>

<p>At this point, even though I haven&#39;t yet wrote a single line of the <code>scale</code>
function, I know quite well how it should work! Importantly, I know the
type of data that will come in this function. This is something I like when
writing code: I need to understand which data go where, and how they are
formatted and transformed along the way. I try to make students think about
this when giving courses. What kind of data go in? What kind of data come
out? This approach forces to determine when and how the function will break,
and it&#39;s great to have a very clear idea of the data types.</p>

<p>Now is the time to program the actual function. It will take one argument,
and return another array (the original one is not modified). Let&#39;s write
the simplest possible form of this function:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
   <span class="k">return</span> <span class="n">p</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></code></pre></div>

<p>In most situations, I would have been happy writing the function this way. Let&#39;s integrate it with the test suite, and see how it goes:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#! /usr/bin/python2</span>

<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="c">## scaleTest goes here</span>

<span class="c">## scale goes here</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
   <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
   <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>Here is the output of running this file:</p>
<div class="highlight"><pre><code class="language-" data-lang="">======================================================================
FAIL: testNegative (__main__.scaleTest)
----------------------------------------------------------------------
Traceback (most recent call last):
File "lv.py", line 21, in testNegative
self.assertRaises(ValueError, scale, WithNeg)
AssertionError: ValueError not raised
======================================================================
FAIL: testNull (__main__.scaleTest)
----------------------------------------------------------------------
Traceback (most recent call last):
File "lv.py", line 18, in testNull
self.assertRaises(ValueError, scale, WithNeg)
AssertionError: ValueError not raised
----------------------------------------------------------------------
Ran 4 tests in 0.001s
FAILED (failures=2)
</code></pre></div>
<p>There are <em>only</em> two failed tests. This is because <code>testOnKnownResult</code> is
expected to succeed, and <code>testType</code> will catch the <code>TypeError</code> raised by
<code>np.max</code> if there are arguments of the bad type. So now I just need to test
that the argument are not negative, or not only zeroes:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
   <span class="c"># We test that values are positive</span>
   <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'Values of p cannot be smaller than 0'</span><span class="p">)</span>
   <span class="c"># We test that values are not all null</span>
   <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'Values of p cannot be all equal to 0'</span><span class="p">)</span>
   <span class="c"># Finally we return the result</span>
   <span class="k">return</span> <span class="n">p</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></code></pre></div>

<p>With these two checks, we can now re-run the tests:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">....
----------------------------------------------------------------------
Ran 4 tests in 0.001s
OK</code></pre></div>

<p>Mission accomplished! It requires some discipline to work this way, but I
actually enjoyed going through this example. I really like the fact that
this approach forces to ask question about the structure of the code first,
and write the actual code later.</p>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'tpoi-hp'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


        </div>
      </div>

    </div>

  </body>
</html>
