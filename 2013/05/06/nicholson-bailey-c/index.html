<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timothée Poisot | A C version of the Nicholson-Bailey model</title>
    <link rel="stylesheet" href="/styles/base.css" />
    <link rel="stylesheet" href="/styles/skeleton.css" />
    <link rel="stylesheet" href="/styles/layout.css" />
    <link rel="stylesheet" href="/styles/style.css" />
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-11830706-1', 'timotheepoisot.fr');
ga('send', 'pageview');
</script>

  </head>
<body>


   <div class="container">

   <div class="three columns sidebar">
   <section id="title">
   <h1>Timothée Poisot</h1>
   <h2>Computational Ecologist</h2>
</section>

   <nav>
   <ul>
   <li><a href="/">Home</a></li>
   <li><a href="/software/">Software</a></li>
   <li><a href="/research/">Research</a></li>
   <li class="active"><a href="/blog/">Blog</a></li>
   <li><a href="/papers/">Papers</a></li>
   <li><a href="/colophon/">Colophon</a></li>
   </ul>
</nav>

   </div>

   <div class="twelve columns offset-by-three">
   <section id="content">
      <div class="post">
   <h1 class="title"> A C version of the Nicholson-Bailey model</h1>
   <p>The Nicholson-Bailey model is a <a href="http://en.wikipedia.org/wiki/Nicholson%E2%80%93Bailey_model">well known</a> model of host and parasitoid population dynamics. It assumes that parasitoids will search a fraction of their habitat for hosts, and then kill them. Yes, it’s brutal like that. There are a few fun things with this model. It’s light in parameters (the single-patch version requires only three parameters), it’s in discrete time (so it’s easy to program), and it’s classical put on a lattice (so it’s a good way to program these kind of things).</p>
<p>I wanted to test a few things, so I had to re-implement this model in space. My <a href="https://gist.github.com/tpoisot/5528745">first version</a> uses python, but it’s remarkably slow. So I decided to write the <a href="">model in C</a>. Either the model is really easy to program, or I’m getting good (I vote for the other solution, because I’m sure my code is full of horrible things), but it was relatively easy to do. <a href="https://gist.github.com/tpoisot/5528759">Go get it</a> and play around. The <code>GSL</code> is required. To get it to run, you’ll need to:</p>
<div class="highlight">
<pre><code class="language-bash" data-lang="bash">mkdir grids
mkdir png
clang nb.c -o nb -lgsl -lgslcblas -O3 -DHAVE_INLINE
chmod +x nb
./nb</code></pre>
</div>
<p>The parameter names are relatively easy to understand. <code>Lh</code> and <code>Lp</code> are the rate of increase of the host and parasite, <code>a</code> is the proportion of space searched, and <code>dh</code> and <code>dp</code> are the dispersal rates. <span class="margin">I’ve never quite understood the relevance of reflective boundaries for lattices of small sizes, unless you model what happens in your garden…</span>Note, by the way, that the world is spherical, so if you reach the edge of the lattice, you emerge on the other side. Other than that, dispersal is strictly local: you disperse to your 8 neighboring cells, and you receive migrants from them as well, with equal probability for each neighboring cell. There is no long-range dispersal either.</p>
<p>The <code>png</code> folder is used by another script, reproduced below, whose job it is to (i) read the output files, and (ii) do a plot using <code>matplotlib</code>.</p>
<div class="highlight">
<pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">progressbar</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">uniq</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
        <span class="n">keys</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">keys</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">rml</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">st</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

<span class="c"># Read all text file in grids/</span>
<span class="c"># Output them all in png/</span>

<span class="n">grid_path</span> <span class="o">=</span> <span class="s">&#39;./grids/&#39;</span>
<span class="n">png_path</span> <span class="o">=</span> <span class="s">&#39;./png/&#39;</span>
<span class="n">dirList</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">grid_path</span><span class="p">)</span>
<span class="n">dirList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">uniq</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">rml</span><span class="p">,</span> <span class="n">dirList</span><span class="p">)))</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">dirList</span><span class="p">),</span><span class="mi">4</span><span class="p">])</span>

<span class="n">pbar</span> <span class="o">=</span> <span class="n">ProgressBar</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dirList</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">dirList</span><span class="p">:</span>
    <span class="c"># Update of the progressbar</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="c"># Timestep</span>
    <span class="n">SimTime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
    <span class="c"># Get the filenames</span>
    <span class="n">h_name</span> <span class="o">=</span> <span class="n">grid_path</span><span class="o">+</span><span class="s">&#39;h_&#39;</span><span class="o">+</span><span class="n">sim</span><span class="o">+</span><span class="s">&#39;.txt&#39;</span>
    <span class="n">p_name</span> <span class="o">=</span> <span class="n">grid_path</span><span class="o">+</span><span class="s">&#39;p_&#39;</span><span class="o">+</span><span class="n">sim</span><span class="o">+</span><span class="s">&#39;.txt&#39;</span>
    <span class="c"># Read the grids</span>
    <span class="n">h_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">h_name</span><span class="p">)</span>
    <span class="n">p_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span>
    <span class="n">prev_grid</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_grid</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">h_grid</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="c"># Output it as a png (host)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">h_grid</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Greys</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png_path</span><span class="o">+</span><span class="s">&#39;h_&#39;</span><span class="o">+</span><span class="n">sim</span><span class="o">+</span><span class="s">&#39;.png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
    <span class="c"># Output it as a png (parasite)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">h_grid</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Greys</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png_path</span><span class="o">+</span><span class="s">&#39;p_&#39;</span><span class="o">+</span><span class="n">sim</span><span class="o">+</span><span class="s">&#39;.png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
    <span class="c"># Output it as a png (prevalence)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">prev_grid</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Greys</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png_path</span><span class="o">+</span><span class="s">&#39;prev_&#39;</span><span class="o">+</span><span class="n">sim</span><span class="o">+</span><span class="s">&#39;.png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">)</span>
    <span class="c"># Save the aggregated infos</span>
    <span class="n">out</span><span class="p">[</span><span class="n">SimTime</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">SimTime</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">h_grid</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p_grid</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">prev_grid</span><span class="p">)]</span>
<span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s">&#39;dynamics.txt&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span></code></pre>
</div>
<p>An example result would look something like this:</p>
<figure>
<img src="/images/nb-static.png" alt="Figure1" /><figcaption>Figure1</figcaption>
</figure>
<p>But the fun part is that, with a few extra steps, you can have cool looking videos. I used <code>ffmpeg</code> to do it. It’s as simple as getting all of the files in the <code>png</code> folder, and putting them together to have an animated, step-by-step output of the model:</p>
<div class="highlight">
<pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>
ffmpeg -qscale <span class="m">5</span> -r <span class="m">20</span> -b <span class="m">9600</span> -i png/h_%05d.png host.mp4
ffmpeg -qscale <span class="m">5</span> -r <span class="m">20</span> -b <span class="m">9600</span> -i png/p_%05d.png para.mp4
ffmpeg -qscale <span class="m">5</span> -r <span class="m">20</span> -b <span class="m">9600</span> -i png/prev_%05d.png prev.mp4</code></pre>
</div>
<p>The C program is quite fast (500 steps with a 100x100 lattice can be done in just a few seconds), but the script to convert the text files in images is really slow. I’m talking tens of minutes slow, so go make yourself a coffee. It’s also extremely hungry in terms of memory, and as with all things Python, will eat up a whole CPU. But it’s worth it! I’ve uploaded an <a href="http://www.youtube.com/embed/wE3x5QABBug">example video</a> if you want to see.</p>
<p>And now… Back to doing whatever I had in mind with this model!</p>
<div class="references">

</div>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'tpoi-hp'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


   </section>
   </div>

   </div>

</body>
</html>
