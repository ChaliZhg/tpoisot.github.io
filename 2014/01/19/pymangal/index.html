<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
extensions: ["tex2jax.js"],
jax: ["input/TeX", "output/HTML-CSS"],
tex2jax: {
inlineMath: [ ['$','$'], ["\\(","\\)"] ],
displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
processEscapes: true
},
"HTML-CSS": { availableFonts: ["TeX"] }
});
</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-11830706-1', 'timotheepoisot.fr');
ga('send', 'pageview');
</script>

<link rel="stylesheet" href="/lib/skeleton/css/normalize.css">
<link rel="stylesheet" href="/lib/skeleton/css/skeleton.css">

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript" src="/lib/site.js" charset="utf-8"></script>

<link rel="stylesheet/less" type="text/css" href="/lib/style.less" />
<script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.3.1/less.min.js"></script>

<title>Timothée Poisot | Python wrapper for mangal</title>

  </head>
  <body><a id="pagetop"></a>

    <!-- .container is main centered wrapper -->
    <div class="container">

      <div class="head">
        <h1>Timothée Poisot</h1>
        <h2>Computational Ecologist</h2>
      </div>

      <nav class="navbar">
  <div class="container">
    <ul class="nav-list">
      <li>
        <a href="/" title="Home">
          <span class="icon"><i class="fa fa-fw fa-home"></i>
          </span><span class="text">Home</span>
        </a>
      </li>
      <li>
        <a href="/software/" title="Software">
          <span class="icon"><i class="fa fa-fw fa-terminal"></i>
          </span><span class="text">Software</span>
        </a>
      </li>
      <li>
        <a href="/research/" title="Research">
          <span class="icon"><i class="fa fa-fw fa-flask"></i>
          </span><span class="text">Research</span>
        </a>
      </li>
      <li>
        <a href="/blog/" class="active" title="Blog">
          <span class="icon"><i class="fa fa-fw fa-bullhorn"></i>
          </span><span class="text">Blog</span>
        </a>
      </li>
      <li>
        <a href="/papers/" title="Papers">
          <span class="icon"><i class="fa fa-fw fa-file-text-o"></i>
          </span><span class="text">Papers</span>
        </a>
      </li>
      <li>
        <a href="/colophon/" title="Colophon">
          <span class="icon"><i class="fa fa-fw fa-info"></i>
          </span><span class="text">Colophon</span>
        </a>
      </li>
    </ul>
  </div>
</nav>


      <!-- columns should be the immediate child of a .row -->
      <div class="row">
        <div class="twelve column content">
          <div class="entry">
<div class='post-title'>2014/01/19<a class="readmore" href="/2014/01/19/pymangal/">Python wrapper for mangal</a></div>
<div class='post-meta'>Written by Tim</div>
<p>I use <code>python</code> more than I use <code>R</code> for my own job. <code>R</code> is good to share
things with people, but it&#39;s a little bit slower, and orders of magnitude
quirkier, than <code>python</code>. So I decided to write a <code>python</code> wrapper for the
<code>mangal</code> API, which you can <a href="https://github.com/mangal-wg/pymangal">find on <em>GitHub</em></a>. It works with
<code>python</code> 2.6 and 2.7 (at least the test suite passes on these two versions).</p>

<p>The goal is <em>not</em> to release something as full-featured as the <code>rmangal</code>
package (though the core abilities will be here). Rather, I wanted a tool that
is &quot;pythonic&quot;, easy to use, and programmed extremely defensively so that it
can be used for automated analyses. There is a minimal <a href="http://pymangal.readthedocs.org/en/latest/">documentation</a>
online, which will hopefully get better over time as I understand the
<code>sphinx</code> markup.</p>

<p>The syntax is relatively similar to that of the <code>rmangal</code> package. Everything starts by the instansiation of a <code>mangal()</code> class.</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pymangal</span> <span class="kn">as</span> <span class="nn">pm</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">api</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">mangal</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s">'http://localhost:8000'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">api</span><span class="o">.</span><span class="n">resources</span>
<span class="p">[</span><span class="s">u'interaction'</span><span class="p">,</span> <span class="s">u'network'</span><span class="p">,</span> <span class="s">u'reference'</span><span class="p">,</span> <span class="s">u'taxa'</span><span class="p">,</span> <span class="s">u'trait'</span><span class="p">,</span> <span class="s">u'dataset'</span><span class="p">,</span> <span class="s">u'environment'</span><span class="p">,</span> <span class="s">u'item'</span><span class="p">,</span> <span class="s">u'user'</span><span class="p">,</span> <span class="s">u'population'</span><span class="p">]</span>
</code></pre></div>
<p>The methods implemented by the <code>mangal</code> class are <code>List</code>, <code>Get</code>, and <code>Post</code>
(<code>Patch</code> is coming soon, and <code>Post</code> support is sketchy at best). They work
almost in the same way as their <code>R</code> counterparts. For example, getting a
list of all networks can be done with:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="n">all_net</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="s">'network'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_net</span><span class="p">)</span>
<span class="mi">17</span>
</code></pre></div>
<p>The only significant difference is that, by default, the <code>python</code> version will only return the first 20 results. If you want more than 20  results, you need to use <code>autopage=True</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="n">twenty_taxa</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="s">'taxa'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">twenty_taxa</span><span class="p">)</span>
<span class="mi">20</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">all_taxa</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="s">'taxa'</span><span class="p">,</span> <span class="n">autopage</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_taxa</span><span class="p">)</span>
<span class="mi">38</span>
</code></pre></div>
<p>The <em>big</em> advantage of the <code>python</code> version is that, when uploading data, there
is a validation of the way they are formatted. Internally, there is a function
taking care of reading the API scheme, and returning it as a <code>json</code> schema,
against which data are checked. It&#39;s probably simpler with a demonstration...</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">schemes</span><span class="p">[</span><span class="s">'trait'</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c">## I have cut some of the elements for the sake of brevity</span>
<span class="p">{</span>
   <span class="s">"$schema"</span><span class="p">:</span> <span class="s">"http://json-schema.org/draft-04/schema#"</span><span class="p">,</span> 
   <span class="s">"required"</span><span class="p">:</span> <span class="p">[</span>
      <span class="s">"value"</span><span class="p">,</span> 
      <span class="s">"owner"</span><span class="p">,</span> 
      <span class="s">"name"</span>
   <span class="p">],</span> 
   <span class="s">"type"</span><span class="p">:</span> <span class="s">"object"</span><span class="p">,</span> 
   <span class="s">"properties"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">"name"</span><span class="p">:</span> <span class="p">{</span>
         <span class="s">"type"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">,</span> 
         <span class="s">"description"</span><span class="p">:</span> <span class="s">"The name of the measured trait"</span>
      <span class="p">},</span> 
      <span class="s">"value"</span><span class="p">:</span> <span class="p">{</span>
         <span class="s">"type"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">,</span> 
         <span class="s">"description"</span><span class="p">:</span> <span class="s">"The value of the trait"</span>
      <span class="p">},</span> 
      <span class="s">"units"</span><span class="p">:</span> <span class="p">{</span>
         <span class="s">"type"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">,</span> 
         <span class="s">"description"</span><span class="p">:</span> <span class="s">"Units in which the trait was measured"</span>
      <span class="p">}</span>
   <span class="p">},</span> 
   <span class="s">"title"</span><span class="p">:</span> <span class="s">"Autogenerated JSON schema"</span>
<span class="p">}</span>
</code></pre></div>
<p>The data are validated <em>automatically</em>, so you don&#39;t have to bother about checking them yourself. For example, let&#39;s try with a badly formatted, and with a correctly formatted, taxa [^1]:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="n">bad_taxa</span> <span class="o">=</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Vulpes lagopus'</span><span class="p">,</span> <span class="s">'vernacular'</span><span class="p">:</span> <span class="s">'arctic fox'</span><span class="p">,</span> <span class="s">'eol'</span><span class="p">:</span> <span class="mi">1053894</span><span class="p">,</span> <span class="s">'status'</span><span class="p">:</span> <span class="s">'valid'</span><span class="p">}</span>
<span class="c"># "valid" is not an acceptable value for "status" ("confirmed" is)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ok_taxa</span> <span class="o">=</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Vulpes lagopus'</span><span class="p">,</span> <span class="s">'vernacular'</span><span class="p">:</span> <span class="s">'arctic fox'</span><span class="p">,</span> <span class="s">'eol'</span><span class="p">:</span> <span class="mi">1053894</span><span class="p">,</span> <span class="s">'status'</span><span class="p">:</span> <span class="s">'confirmed'</span><span class="p">}</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">arctic_fox</span> <span class="o">=</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">arctic_fox</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Post</span><span class="p">(</span><span class="s">'taxa'</span><span class="p">,</span> <span class="n">bad_taxa</span><span class="p">)</span>
<span class="c"># Skipping some lines...</span>
<span class="n">jsonschema</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">:</span> <span class="s">'valid'</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">one</span> <span class="n">of</span> <span class="p">[</span><span class="s">u'confirmed'</span><span class="p">,</span> <span class="s">u'trophic species'</span><span class="p">,</span> <span class="s">u'morphospecies'</span><span class="p">,</span> <span class="s">u'nomen dubium'</span><span class="p">,</span> <span class="s">u'nomen oblitum'</span><span class="p">,</span> <span class="s">u'nomen nudum'</span><span class="p">,</span> <span class="s">u'nomen novum'</span><span class="p">,</span> <span class="s">u'nomen conservandum'</span><span class="p">,</span> <span class="s">u'species inquirenda'</span><span class="p">]</span>

<span class="n">Failed</span> <span class="n">validating</span> <span class="s">'enum'</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="s">'properties'</span><span class="p">][</span><span class="s">u'status'</span><span class="p">]:</span>
<span class="p">{</span><span class="s">'description'</span><span class="p">:</span> <span class="s">u'The taxonomic status of the taxa.'</span><span class="p">,</span>
   <span class="s">'enum'</span><span class="p">:</span> <span class="p">[</span><span class="s">u'confirmed'</span><span class="p">,</span>
   <span class="s">u'trophic species'</span><span class="p">,</span>
   <span class="s">u'morphospecies'</span><span class="p">,</span>
   <span class="s">u'nomen dubium'</span><span class="p">,</span>
   <span class="s">u'nomen oblitum'</span><span class="p">,</span>
   <span class="s">u'nomen nudum'</span><span class="p">,</span>
   <span class="s">u'nomen novum'</span><span class="p">,</span>
   <span class="s">u'nomen conservandum'</span><span class="p">,</span>
   <span class="s">u'species inquirenda'</span><span class="p">],</span>
<span class="s">'type'</span><span class="p">:</span> <span class="s">u'string'</span><span class="p">}</span>

<span class="n">On</span> <span class="n">instance</span><span class="p">[</span><span class="s">u'status'</span><span class="p">]:</span>
<span class="s">'valid'</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">arctic_fox</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Post</span><span class="p">(</span><span class="s">'taxa'</span><span class="p">,</span> <span class="n">ok_taxa</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">arctic_fox</span><span class="p">[</span><span class="s">'id'</span><span class="p">]</span>
<span class="mi">103</span>
</code></pre></div>
<p>Note that the <code>validate</code> function of the <code>jsonschema</code> will tell you what is
wrong with the data, and show you the relevant excerpt from the schema. This
really helps finding out what it wrong with the data you try to upload.</p>

<hr>

<p>As a final note: I am using <em><a href="https://coveralls.io/r/mangal-wg/pymangal">Coveralls.io</a></em> for the first time,
and I am extremely impressed. In short, <em>coveralls</em> will read the results
of the <code>coverage</code> command, and tell you the proportion of your code with
corresponding test cases. <em>Coveralls</em> is integrated with <em>TravisCI</em>, a
continuous integration engine runnign the test suite each time I commit
changes to the <em>GitHub</em> repository (so I have confirmation that the new
versions pass  the tests). And finally, the documentation is auto-generated
using <em>Read The Docs</em>, which extracts the informations directly from the
code. These are really impressive tools to work with, and they kind of force
good practices upon you -- which is a good thing.</p>

<p>[^1]: As usual, posting and patching requires that you have a username and password. There will be a way to register through the <code>python</code> package in the future.</p>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'tpoi-hp'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


        </div>
      </div>

    </div>

  </body>
</html>
