<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="//use.typekit.net/kvz6lyh.js"></script>
<script>try{Typekit.load();}catch(e){}</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-11830706-1', 'timotheepoisot.fr');
ga('send', 'pageview');
</script>

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/base-min.css">
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css">
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/grids-responsive-min.css">

<title>Timothée Poisot | Examples of mangal in action</title>
<link rel="stylesheet" href="/styles/style.css" />

  </head>
<body>

<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
        <div class="header">
            <h1 class="brand-title">Timothée Poisot</h1>
            <h2 class="brand-tagline">Computational Ecologist</h2>
           <nav class="nav">
   <ul class="nav-list">
   <li><a href="/">Home</a></li>
   <li><a href="/software/">Software</a></li>
   <li><a href="/research/">Research</a></li>
   <li class="active"><a href="/blog/">Blog</a></li>
   <li><a href="/papers/">Papers</a></li>
   <li><a href="/colophon/">Colophon</a></li>
   </ul>
</nav>

        </div>
    </div>
    <div class="content pure-u-1 pure-u-md-3-4">
       <div class="entry">
<div class='post-title'><a class="readmore" href="/2014/01/09/mangal-in-action/">Examples of mangal in action</a></div>
<div class='post-date'>On January  9, 2014 &middot; 
   Tim
</div>
<p>In the two previous posts (see <a href="http://timotheepoisot.fr/2014/01/07/mangal-database-networks/">Part 1</a> and <a href="http://timotheepoisot.fr/2014/01/08/mangal-add-data/">Part 2</a>), I’ve presented the basics of using <code>mangal</code> and the <code>rmangal</code> package to access, deposit, and edit data about ecological networks. The final post in the series is going to be slightly more fun: I’ll illustrate some use cases of things you can potentially do with the database. We will start from the representation of a network in space, then move on to measuring beta-diversity in the dataset, and end with some more classical species-links relationships.</p>
<h1 id="setting-things-up">Setting things up</h1>
<p>We’ll need to pull the latest version of <code>rmangal</code>, as usual. In addition, we’ll need a few other packages.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">options</span>(<span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)
if (<span class="kw">getOption</span>(<span class="st">&quot;unzip&quot;</span>) ==<span class="st"> &quot;&quot;</span>) <span class="kw">options</span>(<span class="dt">unzip =</span> <span class="st">&quot;unzip&quot;</span>)
<span class="kw">library</span>(devtools)
<span class="kw">install_github</span>(<span class="st">&quot;rmangal&quot;</span>, <span class="st">&quot;mangal-wg&quot;</span>)
<span class="kw">install_github</span>(<span class="st">&quot;betalink&quot;</span>, <span class="st">&quot;tpoisot&quot;</span>)
<span class="kw">library</span>(rmangal)
<span class="co"># Let&#39;s connect to the database</span>
URL &lt;-<span class="st"> &quot;http://localhost:8000&quot;</span>
api &lt;-<span class="st"> </span>rmangal::<span class="kw">mangalapi</span>(URL)
<span class="kw">library</span>(betalink)
<span class="co"># Tools for spatial analyses</span>
<span class="kw">library</span>(sp)
<span class="kw">library</span>(RgoogleMaps)
<span class="kw">library</span>(RColorBrewer)</code></pre>
<p><span class="margin">Ricciardi et al. (2010) <em>Env Biol Fishes</em> <a href="http://dx.doi.org/10.1007/s10641-010-9606-0">DOI</a></span>I will do everything using a dataset released by Ricciardi and colleagues. The <a href="http://www.nceas.ucsb.edu/interactionweb/html/ricciardi-et-al-2010.html">original data</a> are on the <em>Interaction Web DataBase</em>. This dataset describes 16 anemonefish/fishes mutualistic networks in Indonesia. It’s an extremely cool dataset, because (i) there are a lot of sites in a small space, (ii) a lot of species are in common across sites, and (iii) anemonefishes. So I’ve uploaded these data in my local copy of the database, and I’m going to illustrate a few uses-cases. The only “manual” operation was determining the spatial coordinates in each networks, based on the map presented in the original paper.</p>
<h1 id="use-case-1-spatialized-network">Use-case 1: spatialized network</h1>
<p><span class="margin">Bascompte (2009) <em>Science</em> <a href="http://dx.doi.org/10.1126/science.1170749">DOI</a></span>There is a really cool figure in one of Jordi Bascompte’s paper, in which a network is plotted in space, and the position of each species is the center of mass of its area. This is an interesting way to plot networks when spatial information is available, so let’s do just that.</p>
<p>We start by getting the dataset:</p>
<pre class="sourceCode r"><code class="sourceCode r">Dataset &lt;-<span class="st"> </span><span class="kw">getDataset</span>(api, <span class="dv">8</span>)
Dataset$networks</code></pre>
<pre><code>##  [1] &quot;32&quot; &quot;33&quot; &quot;18&quot; &quot;19&quot; &quot;20&quot; &quot;21&quot; &quot;22&quot; &quot;23&quot; &quot;24&quot; &quot;25&quot; &quot;26&quot; &quot;27&quot; &quot;28&quot; &quot;29&quot;
## [15] &quot;30&quot; &quot;31&quot;</code></pre>
<p>Now, this dataset has a lot of networks. So we’ll do to things. First, we will get a list of all network objects, because they have the metadata we need:</p>
<pre class="sourceCode r"><code class="sourceCode r">Networks &lt;-<span class="st"> </span><span class="kw">alply</span>(Dataset$networks, <span class="dv">1</span>, function(x) <span class="kw">getNetwork</span>(api, x))
Networks[[<span class="dv">1</span>]]$latitude</code></pre>
<pre><code>## [1] 1.651</code></pre>
<p>Next, we will call the <code>network_as_graph</code> function to get all the interactions, and associated informations on the taxa. We will also convert these graphs into matrices, because that will be easier for some of the next steps.</p>
<pre class="sourceCode r"><code class="sourceCode r">Graphs &lt;-<span class="st"> </span><span class="kw">llply</span>(Networks, function(x) <span class="kw">network_as_graph</span>(api, x$id))
<span class="kw">names</span>(Graphs) &lt;-<span class="st"> </span><span class="kw">laply</span>(Networks, function(x) x$name)
Matrices &lt;-<span class="st"> </span><span class="kw">llply</span>(Graphs, get.adjacency, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)</code></pre>
<p>Let’s now get a table with the sites spatial coordinates:</p>
<pre class="sourceCode r"><code class="sourceCode r">Coord &lt;-<span class="st"> </span><span class="kw">ldply</span>(Networks, function(x) <span class="kw">c</span>(<span class="dt">name =</span> x$name, <span class="dt">lon =</span> x$longitude, <span class="dt">lat =</span> x$latitude))
<span class="kw">rownames</span>(Coord) &lt;-<span class="st"> </span>Coord$name
Coord &lt;-<span class="st"> </span>Coord[, <span class="kw">c</span>(<span class="st">&quot;lat&quot;</span>, <span class="st">&quot;lon&quot;</span>)]
Coord$lat &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(Coord$lat)
Coord$lon &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(Coord$lon)
<span class="kw">head</span>(Coord)</code></pre>
<pre><code>##                 lat   lon
## Tanjung Kopi  1.651 124.7
## Tanjung Pisok 1.578 124.8
## bahowo        1.585 124.8
## Kampung Bajo  1.608 124.9
## Batu Kapal    1.788 124.8
## Bualo         1.616 124.7</code></pre>
<p>Good!</p>
<p>Almost final steps, let’s (i) get the list of species in each site, (ii) make a community matrix from this, and (iii) calculate the center of mass of each species based on its occurence in each of the 16 locations.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Get the list of species</span>
sp_by_site &lt;-<span class="st"> </span><span class="kw">llply</span>(Graphs, function(x) <span class="kw">unlist</span>(<span class="kw">V</span>(x)$name))
sp_list &lt;-<span class="st"> </span><span class="kw">unique</span>(<span class="kw">unlist</span>(sp_by_site))

<span class="co"># Species-by-site matrix</span>
M &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">ncol =</span> <span class="kw">length</span>(sp_list), <span class="dt">nrow =</span> <span class="kw">length</span>(sp_by_site))
<span class="kw">colnames</span>(M) &lt;-<span class="st"> </span>sp_list
<span class="kw">rownames</span>(M) &lt;-<span class="st"> </span><span class="kw">names</span>(sp_by_site)
for (site in <span class="kw">c</span>(<span class="dv">1</span>:<span class="kw">length</span>(sp_by_site))) M[<span class="kw">names</span>(sp_by_site)[site], sp_by_site[[site]]] =<span class="st"> </span><span class="dv">1</span>

<span class="co"># Get the center of mass for each species</span>
sp_center &lt;-<span class="st"> </span><span class="kw">adply</span>(M, <span class="dv">2</span>, function(x) <span class="kw">colMeans</span>(Coord[<span class="kw">names</span>(x)[x &gt;<span class="st"> </span><span class="dv">0</span>], ]))
<span class="kw">rownames</span>(sp_center) &lt;-<span class="st"> </span>sp_center[, <span class="dv">1</span>]
sp_center &lt;-<span class="st"> </span>sp_center[, -<span class="dv">1</span>]
<span class="kw">head</span>(sp_center)</code></pre>
<pre><code>##                           lat   lon
## Entacmaea quadricolor   1.599 124.8
## Heteractis aurora       1.677 124.8
## Heteractis crispa       1.614 124.8
## Stichodactyla mertensii 1.625 124.8
## Heteractis magnifica    1.601 124.8
## Amphiprion melanopus    1.620 124.7</code></pre>
<p>Finally, we use the <code>metaweb</code> function from <code>betalink</code> to get the regional network, as an <code>igraph</code> graph:</p>
<pre class="sourceCode r"><code class="sourceCode r">Mw &lt;-<span class="st"> </span><span class="kw">graph.adjacency</span>(<span class="kw">metaweb</span>(Matrices)$web)</code></pre>
<p>And now, we’ll use the <code>RgoogleMaps</code> package to plot a map, and overlay the spatialized network on top:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># But first we need this function to convert spatial coordinates</span>
ll_to_gm &lt;-<span class="st"> </span>function(Map, ll) {
    <span class="co"># Lat. conversion</span>
    lat &lt;-<span class="st"> </span>ll$lat
    lat &lt;-<span class="st"> </span>lat -<span class="st"> </span>Map$lat.center
    lat &lt;-<span class="st"> </span>lat/(Map$BBOX$ur[, <span class="st">&quot;lat&quot;</span>] -<span class="st"> </span>Map$BBOX$ll[, <span class="st">&quot;lat&quot;</span>])
    lat &lt;-<span class="st"> </span>lat *<span class="st"> </span><span class="dv">640</span>
    <span class="co"># Lat. conversion</span>
    lon &lt;-<span class="st"> </span>ll$lon
    lon &lt;-<span class="st"> </span>lon -<span class="st"> </span>Map$lon.center
    lon &lt;-<span class="st"> </span>lon/(Map$BBOX$ur[, <span class="st">&quot;lon&quot;</span>] -<span class="st"> </span>Map$BBOX$ll[, <span class="st">&quot;lon&quot;</span>])
    lon &lt;-<span class="st"> </span>lon *<span class="st"> </span><span class="dv">640</span>
    ## Return matrix
    <span class="kw">return</span>(<span class="kw">cbind</span>(lon, lat))
}
<span class="co"># Plot a map</span>
center_point &lt;-<span class="st"> </span><span class="kw">colMeans</span>(sp_center)
Map &lt;-<span class="st"> </span><span class="kw">GetMap</span>(<span class="dt">center =</span> center_point, <span class="dt">zoom =</span> <span class="dv">11</span>, <span class="dt">SCALE =</span> <span class="dv">1</span>)
<span class="kw">par</span>(<span class="dt">pty =</span> <span class="st">&quot;s&quot;</span>)
colors &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">brewer.pal</span>(<span class="dv">9</span>, <span class="st">&quot;Set1&quot;</span>), <span class="kw">brewer.pal</span>(<span class="dv">8</span>, <span class="st">&quot;Set2&quot;</span>))
<span class="kw">PlotOnStaticMap</span>(Map)
<span class="kw">plot</span>(Mw, <span class="dt">layout =</span> <span class="kw">jitter</span>(<span class="kw">ll_to_gm</span>(Map, sp_center), <span class="dt">amount =</span> <span class="dv">10</span>), <span class="dt">rescale =</span> <span class="ot">FALSE</span>, 
    <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">vertex.size =</span> <span class="dv">600</span>, <span class="dt">vertex.label =</span> <span class="ot">NA</span>, <span class="dt">vertex.color =</span> colors, 
    <span class="dt">edge.arrow.size =</span> <span class="fl">0.25</span>, <span class="dt">edge.color =</span> <span class="dv">1</span>)
<span class="kw">legend</span>(<span class="st">&quot;bottomleft&quot;</span>, <span class="dt">fill =</span> colors, <span class="dt">legend =</span> <span class="kw">V</span>(Mw)$name, <span class="dt">inset =</span> <span class="fl">0.02</span>, <span class="dt">cex =</span> <span class="fl">0.7</span>, 
    <span class="dt">bty =</span> <span class="st">&quot;n&quot;</span>)</code></pre>
<figure>
<img src="/rfig/mangal_make_map_network.png" alt="plot of chunk mangal_make_map_network" /><figcaption>plot of chunk mangal_make_map_network</figcaption>
</figure>
<p>And here we are! It might not be the best-looking graph ever, but I was fairly surprised that it was so easy to produce.</p>
<h1 id="use-case-2-network-β-diversity">Use-case 2: network β-diversity</h1>
<p>For use-case number two, I will use the functions in <code>betalink</code> to do a quick illustration of how network β-diversity depends on the distance between two networks. In the first use case, we have created a <code>Matrices</code> objects, which is a list of matrices. So we can simply do:</p>
<pre class="sourceCode r"><code class="sourceCode r">bdiv &lt;-<span class="st"> </span><span class="kw">betalink.dist</span>(Matrices)</code></pre>
<p>We’ll add the spatial distance between sites, using a function from the <code>sp</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">GeoDist &lt;-<span class="st"> </span><span class="kw">spDists</span>(<span class="kw">as.matrix</span>(Coord), <span class="dt">longlat =</span> <span class="ot">TRUE</span>)
<span class="kw">colnames</span>(GeoDist) &lt;-<span class="st"> </span><span class="kw">rownames</span>(GeoDist) &lt;-<span class="st"> </span><span class="kw">rownames</span>(Coord)
bdiv$Space &lt;-<span class="st"> </span><span class="kw">as.dist</span>(GeoDist)</code></pre>
<p>And now, some plots:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfcol =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
<span class="kw">with</span>(bdiv, {
    <span class="kw">plot</span>(Space, WN, <span class="dt">pch =</span> <span class="dv">19</span>, <span class="dt">xlab =</span> <span class="st">&quot;Distance (in km.)&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Network dissim. (all species)&quot;</span>)
    <span class="kw">plot</span>(Space, OS, <span class="dt">pch =</span> <span class="dv">19</span>, <span class="dt">xlab =</span> <span class="st">&quot;Distance (in km.)&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Network dissim. (common species)&quot;</span>)
})</code></pre>
<figure>
<img src="/rfig/betadiv_rmangal_plots.png" alt="plot of chunk betadiv_rmangal_plots" /><figcaption>plot of chunk betadiv_rmangal_plots</figcaption>
</figure>
<p>And here is a cool new mini-result: the dissimilarity of networks increases with distance overal, but not when you only account for the species which are shared between two locations.</p>
<h1 id="use-case-3-link-species-relationships">Use-case 3: link-species relationships</h1>
<p>Let’s end with a more classical example: in this system, what is the relationship between number of species (S), and number of interactions (L)? This information is super easy to get with a little bit of <code>plyr</code> magic:</p>
<pre class="sourceCode r"><code class="sourceCode r">LS &lt;-<span class="st"> </span><span class="kw">ldply</span>(Graphs, function(x) <span class="kw">c</span>(<span class="dt">S =</span> <span class="kw">length</span>(<span class="kw">V</span>(x)), <span class="dt">L =</span> <span class="kw">length</span>(<span class="kw">E</span>(x))))
<span class="kw">head</span>(LS)</code></pre>
<pre><code>##             .id  S  L
## 1  Tanjung Kopi 10  8
## 2 Tanjung Pisok  9  7
## 3        bahowo 11 10
## 4  Kampung Bajo  6  4
## 5    Batu Kapal  5  4
## 6         Bualo  9  8</code></pre>
<p>The only thing left is to plot this table:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(LS[, <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>)], <span class="dt">log =</span> <span class="st">&quot;xy&quot;</span>, <span class="dt">xlab =</span> <span class="st">&quot;Species&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Links&quot;</span>, <span class="dt">pch =</span> <span class="dv">19</span>)</code></pre>
<figure>
<img src="/rfig/mangal_demo_ls_png.png" alt="plot of chunk mangal_demo_ls.png" /><figcaption>plot of chunk mangal_demo_ls.png</figcaption>
</figure>
<p>We find the expect positive, log/log relationship. And it only required three lines of code!</p>
<h1 id="to-conclude">To conclude</h1>
<p>These three use cases are (I think) good examples of what can be done with the <code>rmangal</code> package. I’ll refine them a little bit to add in the paper. If you have nay any suggestions, that would be greatly appreciated as well!</p>
<div class="references">

</div>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'tpoi-hp'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


    </div>
</div>


</body>
</html>
