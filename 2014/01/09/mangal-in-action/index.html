<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
   <link rel="stylesheet" href="/css/normalize.css">
	<link rel="stylesheet" href="/css/foundation.min.css">
   <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
   <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	<link rel="stylesheet" href="/css/d3.css" />
	<link rel="stylesheet" href="/css/pygments.css" />
   <link rel="stylesheet/less" type="text/css" href="/css/tim.less" />
   <script type="text/javascript" src="/lib/less.js"></script>
   <link rel="stylesheet" href="/lib/highlight/styles/tomorrow.css" />
   <script type="text/javascript" src="/lib/highlight/highlight.pack.js"></script>
   <script>hljs.initHighlightingOnLoad();</script>
   <script src="http://d3js.org/d3.v3.min.js"></script>
   <link rel="alternate" type="application/atom+xml" title="RSS Feed for Tim's blog" href="http://feeds.feedburner.com/timpoisot" />
    
    <script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-11830706-1']);
		_gaq.push(['_trackPageview']);

		(function() {
		 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
	
	<meta name="author" content="Tim Poisot" />
   <title>Timothée Poisot :: Examples of mangal in action</title>
    
</head>

<body>
<a id="top"></a>

            <div class='contain-to-grid fixed'>
<nav class="top-bar" data-topbar>
     <ul class="title-area">
       <li class="name">
       <h1><a href="#top">Timothée Poisot</a></h1>
       </li>
       <li class="toggle-topbar menu-icon"><a href="#">Menu</a></li>
     </ul>

       <section class="top-bar-section">
         <!-- Right Nav Section -->
            <ul class="no-bullet main-nav right">
               <li><a href="/">Home</a></li>
               <li><a href="/papers/">Papers</a></li>
               <li><a href="/software/">Software</a></li>
               <li><a href="/research/">Research</a></li>
               <li class="active"><a href="/blog/">Blog</a></li>
            </ul>

             <!-- Left Nav Section -->
             <ul class="left">
                <li><a>Spatial ecology of species interactions</a></li>
             </ul>
           </section>
        </nav>
     </div>

<div class="row wrapper">
   <div class = "copy">
      <div class="large-12 small-12 columns maintext">
         <div class='post'>
<h1>Examples of mangal in action</h1>

   <div class="postinfo">
      January  9, 2014 &mdash; <span class="label radius small secondary" style="margin-right: 3px;"><a href="/tag/open science/">open science</a></span><span class="label radius small secondary" style="margin-right: 3px;"><a href="/tag/R/">R</a></span><span class="label radius small secondary" style="margin-right: 3px;"><a href="/tag/mangal/">mangal</a></span><span class="label radius small secondary" style="margin-right: 3px;"><a href="/tag/ecological networks/">ecological networks</a></span>
   </div>


<p>In the two previous posts (see <a href="http://timotheepoisot.fr/2014/01/07/mangal-database-networks/">Part 1</a> and <a href="http://timotheepoisot.fr/2014/01/08/mangal-add-data/">Part 2</a>), I’ve presented the basics of using <code>mangal</code> and the <code>rmangal</code> package to access, deposit, and edit data about ecological networks. The final post in the series is going to be slightly more fun: I’ll illustrate some use cases of things you can potentially do with the database. We will start from the representation of a network in space, then move on to measuring beta-diversity in the dataset, and end with some more classical species-links relationships.</p>

<h1 id="setting-things-up">Setting things up</h1>

<p>We’ll need to pull the latest version of <code>rmangal</code>, as usual. In addition, we’ll need a few other packages.</p>

<pre><code class="language-r">options(stringsAsFactors = FALSE)
if (getOption("unzip") == "") options(unzip = "unzip")
library(devtools)
install_github("rmangal", "mangal-wg")
install_github("betalink", "tpoisot")
library(rmangal)
# Let's connect to the database
URL &lt;- "http://localhost:8000"
api &lt;- rmangal::mangalapi(URL)
library(betalink)
# Tools for spatial analyses
library(sp)
library(RgoogleMaps)
library(RColorBrewer)
</code></pre>

<p><span class="margin">Ricciardi et al. (2010) <em>Env Biol Fishes</em> <a href="http://dx.doi.org/10.1007/s10641-010-9606-0">DOI</a></span>I will do everything using a dataset released by Ricciardi and colleagues. The <a href="http://www.nceas.ucsb.edu/interactionweb/html/ricciardi-et-al-2010.html">original data</a> are on the <em>Interaction Web DataBase</em>. This dataset describes 16 anemonefish/fishes mutualistic networks in Indonesia. It’s an extremely cool dataset, because (i) there are a lot of sites in a small space, (ii) a lot of species are in common across sites, and (iii) anemonefishes. So I’ve uploaded these data in my local copy of the database, and I’m going to illustrate a few uses-cases. The only “manual” operation was determining the spatial coordinates in each networks, based on the map presented in the original paper.</p>

<h1 id="use-case-1-spatialized-network">Use-case 1: spatialized network</h1>

<p><span class="margin">Bascompte (2009) <em>Science</em> <a href="http://dx.doi.org/10.1126/science.1170749">DOI</a></span>There is a really cool figure in one of Jordi Bascompte’s paper, in which a network is plotted in space, and the position of each species is the center of mass of its area. This is an interesting way to plot networks when spatial information is available, so let’s do just that.</p>

<p>We start by getting the dataset:</p>

<pre><code class="language-r">Dataset &lt;- getDataset(api, 8)
Dataset$networks
</code></pre>

<pre><code>##  [1] "32" "33" "18" "19" "20" "21" "22" "23" "24" "25" "26" "27" "28" "29"
## [15] "30" "31"
</code></pre>

<p>Now, this dataset has a lot of networks. So we’ll do to things. First, we will get a list of all network objects, because they have the metadata we need:</p>

<pre><code class="language-r">Networks &lt;- alply(Dataset$networks, 1, function(x) getNetwork(api, x))
Networks[[1]]$latitude
</code></pre>

<pre><code>## [1] 1.651
</code></pre>

<p>Next, we will call the <code>network_as_graph</code> function to get all the interactions, and associated informations on the taxa. We will also convert these graphs into matrices, because that will be easier for some of the next steps.</p>

<pre><code class="language-r">Graphs &lt;- llply(Networks, function(x) network_as_graph(api, x$id))
names(Graphs) &lt;- laply(Networks, function(x) x$name)
Matrices &lt;- llply(Graphs, get.adjacency, sparse = FALSE)
</code></pre>

<p>Let’s now get a table with the sites spatial coordinates:</p>

<pre><code class="language-r">Coord &lt;- ldply(Networks, function(x) c(name = x$name, lon = x$longitude, lat = x$latitude))
rownames(Coord) &lt;- Coord$name
Coord &lt;- Coord[, c("lat", "lon")]
Coord$lat &lt;- as.numeric(Coord$lat)
Coord$lon &lt;- as.numeric(Coord$lon)
head(Coord)
</code></pre>

<pre><code>##                 lat   lon
## Tanjung Kopi  1.651 124.7
## Tanjung Pisok 1.578 124.8
## bahowo        1.585 124.8
## Kampung Bajo  1.608 124.9
## Batu Kapal    1.788 124.8
## Bualo         1.616 124.7
</code></pre>

<p>Good!</p>

<p>Almost final steps, let’s (i) get the list of species in each site, (ii) make a community matrix from this, and (iii) calculate the center of mass of each species based on its occurence in each of the 16 locations. </p>

<pre><code class="language-r"># Get the list of species
sp_by_site &lt;- llply(Graphs, function(x) unlist(V(x)$name))
sp_list &lt;- unique(unlist(sp_by_site))

# Species-by-site matrix
M &lt;- matrix(0, ncol = length(sp_list), nrow = length(sp_by_site))
colnames(M) &lt;- sp_list
rownames(M) &lt;- names(sp_by_site)
for (site in c(1:length(sp_by_site))) M[names(sp_by_site)[site], sp_by_site[[site]]] = 1

# Get the center of mass for each species
sp_center &lt;- adply(M, 2, function(x) colMeans(Coord[names(x)[x &gt; 0], ]))
rownames(sp_center) &lt;- sp_center[, 1]
sp_center &lt;- sp_center[, -1]
head(sp_center)
</code></pre>

<pre><code>##                           lat   lon
## Entacmaea quadricolor   1.599 124.8
## Heteractis aurora       1.677 124.8
## Heteractis crispa       1.614 124.8
## Stichodactyla mertensii 1.625 124.8
## Heteractis magnifica    1.601 124.8
## Amphiprion melanopus    1.620 124.7
</code></pre>

<p>Finally, we use the <code>metaweb</code> function from <code>betalink</code> to get the regional network, as an <code>igraph</code> graph:</p>

<pre><code class="language-r">Mw &lt;- graph.adjacency(metaweb(Matrices)$web)
</code></pre>

<p>And now, we’ll use the <code>RgoogleMaps</code> package to plot a map, and overlay the spatialized network on top:</p>

<pre><code class="language-r"># But first we need this function to convert spatial coordinates
ll_to_gm &lt;- function(Map, ll) {
    # Lat. conversion
    lat &lt;- ll$lat
    lat &lt;- lat - Map$lat.center
    lat &lt;- lat/(Map$BBOX$ur[, "lat"] - Map$BBOX$ll[, "lat"])
    lat &lt;- lat * 640
    # Lat. conversion
    lon &lt;- ll$lon
    lon &lt;- lon - Map$lon.center
    lon &lt;- lon/(Map$BBOX$ur[, "lon"] - Map$BBOX$ll[, "lon"])
    lon &lt;- lon * 640
    ## Return matrix
    return(cbind(lon, lat))
}
# Plot a map
center_point &lt;- colMeans(sp_center)
Map &lt;- GetMap(center = center_point, zoom = 11, SCALE = 1)
par(pty = "s")
colors &lt;- c(brewer.pal(9, "Set1"), brewer.pal(8, "Set2"))
PlotOnStaticMap(Map)
plot(Mw, layout = jitter(ll_to_gm(Map, sp_center), amount = 10), rescale = FALSE, 
    add = TRUE, vertex.size = 600, vertex.label = NA, vertex.color = colors, 
    edge.arrow.size = 0.25, edge.color = 1)
legend("bottomleft", fill = colors, legend = V(Mw)$name, inset = 0.02, cex = 0.7, 
    bty = "n")
</code></pre>

<p><img src="/rfig/mangal_make_map_network.png" alt="plot of chunk mangal_make_map_network" /> </p>

<p>And here we are! It might not be the best-looking graph ever, but I was fairly surprised that it was so easy to produce.</p>

<h1 id="use-case-2-network-beta-diversity">Use-case 2: network β-diversity</h1>

<p>For use-case number two, I will use the functions in <code>betalink</code> to do a quick illustration of how network β-diversity depends on the distance between two networks. In the first use case, we have created a <code>Matrices</code> objects, which is a list of matrices. So we can simply do:</p>

<pre><code class="language-r">bdiv &lt;- betalink.dist(Matrices)
</code></pre>

<p>We’ll add the spatial distance between sites, using a function from the <code>sp</code>:</p>

<pre><code class="language-r">GeoDist &lt;- spDists(as.matrix(Coord), longlat = TRUE)
colnames(GeoDist) &lt;- rownames(GeoDist) &lt;- rownames(Coord)
bdiv$Space &lt;- as.dist(GeoDist)
</code></pre>

<p>And now, some plots:</p>

<pre><code class="language-r">par(mfcol = c(1, 2))
with(bdiv, {
    plot(Space, WN, pch = 19, xlab = "Distance (in km.)", ylab = "Network dissim. (all species)")
    plot(Space, OS, pch = 19, xlab = "Distance (in km.)", ylab = "Network dissim. (common species)")
})
</code></pre>

<p><img src="/rfig/betadiv_rmangal_plots.png" alt="plot of chunk betadiv_rmangal_plots" /> </p>

<p>And here is a cool new mini-result: the dissimilarity of networks increases with distance overal, but not when you only account for the species which are shared between two locations.</p>

<h1 id="use-case-3-link-species-relationships">Use-case 3: link-species relationships</h1>

<p>Let’s end with a more classical example: in this system, what is the relationship between number of species (S), and number of interactions (L)? This information is super easy to get with a little bit of <code>plyr</code> magic:</p>

<pre><code class="language-r">LS &lt;- ldply(Graphs, function(x) c(S = length(V(x)), L = length(E(x))))
head(LS)
</code></pre>

<pre><code>##             .id  S  L
## 1  Tanjung Kopi 10  8
## 2 Tanjung Pisok  9  7
## 3        bahowo 11 10
## 4  Kampung Bajo  6  4
## 5    Batu Kapal  5  4
## 6         Bualo  9  8
</code></pre>

<p>The only thing left is to plot this table:</p>

<pre><code class="language-r">plot(LS[, c(2, 3)], log = "xy", xlab = "Species", ylab = "Links", pch = 19)
</code></pre>

<p><img src="/rfig/mangal_demo_ls_png.png" alt="plot of chunk mangal_demo_ls.png" /> </p>

<p>We find the expect positive, log/log relationship. And it only required three lines of code!</p>

<h1 id="to-conclude">To conclude</h1>

<p>These three use cases are (I think) good examples of what can be done with the <code>rmangal</code> package. I’ll refine them a little bit to add in the paper. If you have nay any suggestions, that would be greatly appreciated as well!</p>



</div>



<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'tpoi-hp'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<div class="pager">


<span class="previous">
   <a href="/2014/01/08/mangal-add-data/"><i class="fa fa-fw fa-chevron-left"></i> Previous post</a>
</span>



<span class="next">
<a href="/2014/01/11/animate-networks-with-igraph/">Next post <i class="fa fa-fw fa-chevron-right"></i></a>
</span>

</div>


      </div>
   </div>
   <div class='push'></div>
</div>

<div class="row footer">
   <div class="footercontent">
      <div class="small-4 columns">
<h5>Contact</h5>
<ul class='no-bullet'>
   <li><i class="fa fa-fw fa-envelope"></i> <a href="mailto:t.poisot@gmail.com">E-mail</a></li>
   <li><i class="fa fa-fw fa-twitter-square"></i> <code>@tpoi</code> on <a href="http://twitter.com/tpoi/">Twitter</a></li>
   <li><i class="fa fa-fw fa-github-square"></i> <code>tpoisot</code> on <a href="http://github.com/tpoisot/">GitHub</a></li>
   <li><i class="fa fa-fw fa-rss-square"></i> <a href="http://feeds.feedburner.com/timpoisot/">RSS feed for new posts</a></li>
</ul>
</div>

<div class="small-8 columns">
   <h5>Colophon</h5>
   <p>
	  This website uses <a href='http://foundation.zurb.com/'>Foundation
	  5</a>, <a href='http://fortawesome.github.io/Font-Awesome/'>Font
	  Awesome</a>, is built with <a
	  href='https://github.com/mojombo/jekyll'>Jekyll</a>, and hosted by <a
	  href='http://pages.github.com/'>GitHub pages</a>. Contents under the
	  <a href='http://creativecommons.org/licenses/by-sa/3.0/deed.en_US'>CC
	  BY-SA 3.0</a> licence.
   </p>
</div>


   </div>
</div>
</body>

</html>
